<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Simple Kernel in C and Assembly</title>
<meta name="description" content="Freelance web designer and developer; specialize in minimalist mobile-friendly development; passionate programmer and occasional blogger
">
<meta name="keywords" content="Freelance Web Designer, Debashis Barman, Responsive Web Design, Minimal Web Design"/>

<link rel="stylesheet" href="/kathamo/kathamo.css"/>
<link rel="stylesheet" href="/font-awesome-4.2.0/css/font-awesome.css"/>
<link rel="canonical" href="http://www.debashisbarman.in/2014/09/25/Simple-Kernel-in-C.html">
<link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon">
<style>
/* Global */
h2 { color: #4c6672; padding-bottom: 21px; font-weight: 500; }
p { font-size: 15px; }

/* Header */
header { height: auto; background-color: #4c6672; color: #fff; padding: 34px 0 55px 0; }
header h1 { font-size: 34px; font-weight: 500; }
header p { font-size: 18px; margin: 34px 0 0 0; }
header a, header a:visited { color: #fff; text-decoration: none; outline: 0; font-weight: 500; }
header a:hover, header a:focus { color: #fff; border-bottom: none; }
header p a, header p a:visited { line-height: inherit; }

/* Article */
.article { padding: 21px 0 34px 0; background-color: #f3f5f6; }
.article article { padding: 5px 0; /* border-bottom: 1px dotted #dbe0e3; */ }
.article .date { color: #a0a0a0; font-weight: 500; }
.article a { color: #4c6672; text-decoration: none; outline: 0; font-weight: 500; padding: 0 0 5px 0; /* border-bottom: 1px solid #4c6672; */ border-bottom: none; }
.article a:hover, .article a:focus { color: #4c6672; padding: 0 0 3px 0; /* border-bottom: 1px solid #4c6672; */ border-bottom: none; }
.article p a, .article p a:visited { line-height: inherit; }
.article p { margin: 21px 0 0 0; line-height: 1.618; }

/* Project */
section { padding: 21px 0 34px 0; }
.section a { color: #4c6672; text-decoration: none; outline: 0; font-weight: 500; padding: 0 0 5px 0; border-bottom: 1px solid #4c6672; }
.section a:hover, .section a:focus { color: #4c6672; padding: 0 0 5px 0; border-bottom: 1px solid #4c6672; }
.section p a, .section p a:visited { line-height: inherit; }
.section p { margin: 21px 0 0 0; line-height: 1.618; }

/* Links */
.references { padding: 34px 0 21px 0; }
.references li { border-bottom: 1px dotted #dbe0e3; padding-bottom: 5px; }
.references li .pull-right { color: #dbe0e3; }
.references a { color: #4c6672; text-decoration: none; outline: 0; font-weight: 500; padding: 0 0 2px 0; border-bottom: none; }
.references a:hover, .references a:focus { color: #4c6672; padding: 0 0 2px 0; border-bottom: none; }

/* Footer */
footer { background-color: #4c6672; color: #fff; padding: 21px 0 34px 0; }
footer a, footer a:visited { color: #fff; text-decoration: none; outline: 0; font-weight: 500; }
footer a:hover, footer a:focus { color: #fff; border-bottom: none; }
footer ul.li-inline { font-size: 13px; }

/* Media queries */
@media (min-width: 1024px) {
p { font-size: 16px; }
}
@media (max-width: 767px) {
header { padding: 34px 0; }
h6, p { line-height: 2; }
.article article { border-bottom: 1px dotted #dbe0e3; }
.article a, .article a:hover { border-bottom: none; }
.article .pull-right { color: #dbe0e3; }
.section { padding: 13px 0; }
.section a, .section a:hover { border-bottom: 1px solid #4c6672; }
.text-right { text-align: left; }
}

/* ***************************************************** */

/* Post */
.breadcumb { padding: 0 0 13px 0; }
.post { padding: 34px 0; border-top: 5px solid #4c6672; }
.title { font-size: 34px; margin: 34px 0 21px 0; font-weight: 500; color: #4c6672; }
.subtitle { font-size: 21px; margin: 0 0 55px 0; font-weight: 500; color: #a0a0a0; display: block; }

.post h2, .post h3, .post h4, .post h5, .post h6 { font-size: 21px; font-weight: 500; color: #4c6672; margin: 55px 0 0 0; }

.post p, .post ul { margin: 21px 0; font-size: 15px; line-height: 1.618; }

.post a { color: #4c6672; text-decoration: none; outline: 0; font-weight: 500; padding: 0 0 5px 0; border-bottom: 1px solid #4c6672; }
.post a:hover, .post a:focus { color: #4c6672; padding: 0 0 5px 0; border-bottom: 1px solid #4c6672; }
.post p a, .post p a:visited { line-height: inherit; }
.post p { margin: 21px 0 0 0; line-height: 1.618; }

.post img { margin: 21px 0; }

.post blockquote { border-left: 2px solid #4c6672; }

.post blockquote p { margin: 0; }

.share { padding: 13px 0 34px 0; background-color: #4c6672; color: #fff; }
.share a { color: #fff; text-decoration: none; outline: 0; font-weight: 500; padding: 0 0 5px 0; border-bottom: none; }
.share a:hover, .share a:focus { color: #fff; padding: 0 0 5px 0; border-bottom: none; }
.share p a, .share p a:visited { line-height: inherit; }
.share p { margin: 21px 0 0 0; line-height: 1.618; }


</style>
</head>


<body>

<div>

<div class="post clearfix">

<div class="container clearfix">
<div class="row clearfix">
<div class="col-lg-9 col-md-9 col-sm-12 clearfix">
<small class="breadcumb"><a href="http://www.debashisbarman.in">Home</a> &gt; Simple Kernel in C and Assembly</small>
<h1 class="title">Simple Kernel in C and Assembly</h1>
<span class="subtitle">25 Sep 2014</span>
<p>Hello, world ! Today I’m going to show you how to write a kernel in C and a little bit of assembly. This is a simple kernel written in C and Assembly which could be loaded with the GRUB bootloader on an x86 system. This kernel will
display a message on the screen and then hang. All the source code is available on my github <a href="https://github.com/debashisbarman/Simple-Kernel-in-C-and-Assembly">repository</a>.</p>

<h2 id="tools">Tools</h2>
<p>Before writing the kernel, make sure that the following tools are available on your system.</p>
<ul>
<li>An x86 computer (of course)</li>
<li>Linux</li>
<li>NASM assembler</li>
<li>gcc</li>
<li>ld (GNU Linker)</li>
<li>grub</li>
</ul>

<h2 id="lets-start-coding">Let’s start coding</h2>
<p>We like to write everything in C, but we cannot avoid a little bit of assembly. We will write a small file in x86
assembly-language that serves as the starting point for our kernel. </p>

<p>Here is our <code>kernel.asm</code> file.</p>
<pre>
;; kernel.asm
;; version 0.0.1

bits 32		;nasm directive
section .text
	;multiboot spec
	align 4
	dd 0x1BADB002			;magic
	dd 0x00				;flags
	dd - (0x1BADB002 + 0x00)	;checksum. m+f+c should be zero

global start
extern k_main	;k_main is defined in the kernel.c file

start:
	cli  ; stop interrupts

	call k_main

	hlt ; halt the CPU
</pre>

<p>In the <code>kernel.asm</code> we make a call to <code>k_main</code>. So our execution starts at <code>k_main()</code> in the main C file <code>kernel.c</code>.</p>
<pre>
/*
 *
 * kernel.c - version 0.0.1
 * 
 */


#define WHITE_TXT 0x07 /* light gray on black text */

void k_clear_screen();
unsigned int k_printf(char *message, unsigned int line);

/* simple kernel written in C */
void k_main() 
{
	k_clear_screen();
	k_printf("Hello, world! Welcome to my kernel.", 0);
};

/* k_clear_screen : to clear the entire text screen */
void k_clear_screen()
{
	char *vidmem = (char *) 0xb8000;
	unsigned int i=0;
	while(i &lt; (80*25*2))
	{
		vidmem[i]=' ';
		i++;
		vidmem[i]=WHITE_TXT;
		i++;
	};
};

/* k_printf : the message and the line # */
unsigned int k_printf(char *message, unsigned int line)
{
	char *vidmem = (char *) 0xb8000;
	unsigned int i=0;

	i=(line*80*2);

	while(*message!=0)
	{
		if(*message=='\n') // check for a new line
		{
			line++;
			i=(line*80*2);
			*message++;
		} else {
			vidmem[i]=*message;
			*message++;
			i++;
			vidmem[i]=WHITE_TXT;
			i++;
		};
	};

	return(1);
}
</pre>
<p>All our kernel will do is clear the screen and write to it the string “Hello, world! Welcome to my kernel.”</p>

<p>Now the <code>linker.ld</code> script.</p>
<pre>
/*
 * link.ld
 */

OUTPUT_FORMAT(elf32-i386)
ENTRY(start)
SECTIONS
{
	. = 0x100000;
	.text : {*(.text)}
	.data : {*(.data)}
	.bss  : {*(.bss)}
}
</pre>

<p>That’s it. All done.</p>

<h2 id="building-the-kernel">Building the kernel</h2>
<p>We will now create object files from <code>kernel.asm</code> and <code>kernel.c</code> and then link it using our linker script.</p>
<pre>
nasm -f elf32 kernel.asm -o kasm.o
</pre>
<p>Now we will run the assembler to create the object file <code>kasm.o</code> in ELF-32 bit format.</p>
<pre>
gcc -m32 -c kernel.c -o kc.o
</pre>
<p>Now the linking part,</p>
<pre>
ld -m elf_i386 -T link.ld -o kernel kasm.o kc.o
</pre>

<h2 id="configuring-the-grub">Configuring the grub</h2>
<p>GRUB requires the kernel to be of the name pattern <code>kernel-&lt;version&gt;</code> . So, I renamed my kernel executable to <code>kernel-0.0.1</code>.</p>

<p>Now place it in the <code>/boot</code> directory. You will require superuser privileges to do so.</p>

<p>In your GRUB configuration file <code>grub.cfg</code> you should add an entry, something like:</p>

<pre>
title Mini OS
  root (hd0, 0)
  kernel /boot/kernel-0.0.1 ro
</pre>

<h2 id="using-the-qemu-emulator">Using the qemu emulator</h2>
<p>The kernel will also be run using the <code>qemu</code> emulator.</p>
<pre>
qemu-system-i386 -kernel kernel
</pre>
<p>That’s it.</p>

</div>
</div>
</div>
</div>

<div class="share clearfix">
<div class="container clearfix">
<div class="row clearfix">
<div class="col-lg-9 col-md-12 col-sm-12 clearfix">
<p>Did you enjoy this post? If so, <a href="https://twitter.com/share" data-text="Finishing" data-via="orderedlist" data-count="none"><span class="entypo-twitter"></span>share</a> it!</p>
<p>Have comments on this post or want to discuss further? Hit me up on <span class="fa fa-fw fa-twitter"></span> <a target="_blank" href="https://twitter.com/_DebashisBarman" data-show-count="false" data-show-screen-name="false">Twitter</a> and let me know your thoughts.
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>
</div>
</div>
</div>


<!-- Articles Start -->
<div class="article">
<div class="container clearfix">
<div class="row">

<div class="col-sm-12 visible-sm">
<h2><span class="fa fa-pencil"></span> Articles</h2>
</div>


<div class="col-lg-12 col-md-12 col-sm-12">
<article class="clearfix">
<p><a href="/2014/11/22/Whitespace-in-Webdesign-an-example.html">Whitespace in Webdesign : An Example</a><span class="visible-sm pull-right">+</span>
<span class="pull-right hidden-sm date">22 Nov 2014</span></p>
</article>
</div>

<div class="col-lg-12 col-md-12 col-sm-12">
<article class="clearfix">
<p><a href="/2014/09/25/Simple-Kernel-in-C.html">Simple Kernel in C and Assembly</a><span class="visible-sm pull-right">+</span>
<span class="pull-right hidden-sm date">25 Sep 2014</span></p>
</article>
</div>

<div class="col-lg-12 col-md-12 col-sm-12">
<article class="clearfix">
<p><a href="/2014/08/28/updated-site-design.html">Updated Site Design</a><span class="visible-sm pull-right">+</span>
<span class="pull-right hidden-sm date">28 Aug 2014</span></p>
</article>
</div>

<div class="col-lg-12 col-md-12 col-sm-12">
<article class="clearfix">
<p><a href="/2014/08/26/css-absolute-center.html">CSS Absolute Center</a><span class="visible-sm pull-right">+</span>
<span class="pull-right hidden-sm date">26 Aug 2014</span></p>
</article>
</div>

<div class="col-lg-12 col-md-12 col-sm-12">
<article class="clearfix">
<p><a href="/2014/07/21/introduction-to-markdown.html">Introduction to Markdown</a><span class="visible-sm pull-right">+</span>
<span class="pull-right hidden-sm date">21 Jul 2014</span></p>
</article>
</div>

<div class="col-lg-12 col-md-12 col-sm-12">
<article class="clearfix">
<p><a href="/2014/04/25/elements-of-modern-website.html">Elements of Modern Website</a><span class="visible-sm pull-right">+</span>
<span class="pull-right hidden-sm date">25 Apr 2014</span></p>
</article>
</div>


</div>
</div>
</div>
<!-- Articles end -->


<!-- References Start -->
<div class="references">
<div class="container clearfix">
<div class="row">

<div class="col-sm-12 visible-sm">
<h2><span class="fa fa-link"></span> Links</h2>
</div>

<div class="clearfix">
<div class="col-lg-4 col-md-4 col-sm-12">
<ul>
<li><p><a target="_blank" href="http://debashisbarman.tumblr.com">Tumblr</a><span class="pull-right">+</span></p></li>
<li><p><a target="_blank" href="https://medium.com/@Deb_Speaks">Blog on Medium</a><span class="pull-right">+</span></p></li>
<li><p><a target="_blank" href="https://debashisbarman.wordpress.com">Blog on Wordpress</a><span class="pull-right">+</span></p></li>
</ul>
</div>

<div class="col-lg-4 col-md-4 col-sm-12">
<ul>
<li><p><a target="_blank" href="https://plus.google.com/+DebashisBarman">Google Plus</a><span class="pull-right">+</span></p></li>
<li><p><a target="_blank" href="http://in.linkedin.com/pub/debashis-barman/66/a26/b67">LinkedIn</a><span class="pull-right">+</span></p></li>
<li><p><a target="_blank" href="https://dbuniversity.academia.edu/DebashisBarman">Academia</a><span class="pull-right">+</span></p></li>
<li><p><a target="_blank" href="https://www.skillpages.com/debashis.barman/1">Skillpages</a><span class="pull-right">+</span></p></li>
</ul>
</div>

<div class="col-lg-4 col-md-4 col-sm-12">
<ul>
<li><p><a target="_blank" href="https://gist.github.com/debashisbarman">My Gists</a><span class="pull-right">+</span></p></li>
<li><p><a href="http://www.debashisbarman.in/about/">About the site</a><span class="pull-right">+</span></p></li>
<li><p><a href="http://www.debashisbarman.in/assets/DebashisBarmanCurriculumVitae.pdf">Curriculum Vitae</a><span class="pull-right">+</span></p></li>
</ul>
</div>
</div>

</div>
</div>
</div>
<!-- References end -->


<!-- Footer starts -->
<footer class="clearfix">
<div class="container">
<div class="row">
<div class="col-lg-12 col-md-12 col-sm-12">
<p>Keep track via <a href="/feed.xml">RSS <span class="fa fa-2x fa-rss fa-fw"></span></a></p>
<ul class="li-inline">
<li><span class="fa fa-cog"></span> Built on <a target="_blank" href="http://jekyllrb.com/">Jekyll</a> and hosted on <a target="_blank" href="http://pages.github.com/">Github Pages</a></li>
<li><span class="fa fa-copyright"></span> 2015 Debashis Barman</li>
<li><span class="fa fa-spinner fa-spin"></span> Site under construction</li>
</ul>
</div>
</div>
</div>
</footer>
<!-- Footer ends -->



</div>


</body>
</html>
