<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Simple Kernel in C and Assembly</title>
<meta name="description" content="Freelance web designer and developer; specialize in minimalist mobile-friendly development; passionate programmer and occasional blogger
">
<meta name="keywords" content="Freelance Web Designer, Debashis Barman, Responsive Web Design, Minimal Web Design"/>

<link rel="stylesheet" href="/kathamo/kathamo.css"/>
<link rel="canonical" href="http://www.debashisbarman.in/2014/09/25/Simple-Kernel-in-C.html">
<link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon">
<script type="text/javascript" src="//use.typekit.net/rws3een.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
<style>
/* Icons */
.svg-icon { width: 1em; height: 1em; padding: 3px 0; }
.svg-icon path, .svg-icon polygon, .svg-icon rect { fill: #4c6672; }
.svg-icon circle { stroke: #4c6672; stroke-width: 1; }

/* Anchors */
a, a:visited { color: #4c6672; text-decoration: none; outline: 0; font-weight: 500; }
a:hover, a:focus { color: #4c6672; border-bottom: 1px solid #4c6672; }
p a, p a:visited { line-height: inherit; }

/* Homepage */
#home .ongoing-project { cursor: pointer; pointer-events: none; }

#home header { color: #ffffff; background-color: #4c6672; padding: 55px 0 34px 0; }
#home h1 { text-transform: uppercase; }
#home h6 { text-transform: uppercase; }
#home header h6:before { content: "\2014 \0020"; padding-right: 13px; }
#home header h6:after { content: "\2014 \0020"; padding-left: 13px; }

#home article.myself { padding: 55px 0 34px 0; line-height: 2; }
#home article.myself h2 { color: #4c6672; margin: 0; padding: 0; }
#home article.myself ul.li-inline li { padding: 13px 13px 0 0; }
#home article.myself ul.li-inline a:hover { border-bottom: none; }
#home article.myself .hr-line { background-color: #4c6672; height: 150px; width: 1px; margin: 0 auto; }

#home article.mywork { background-color: #f3f5f6; padding: 55px 0 34px 0; line-height: 2; }
#home article.mywork ul li { margin-bottom: 21px; }
#home article.mywork ul li p { line-height: 2; }
#home article.mywork h2 { color: #4c6672; margin: 0; padding: 0; }
#home article.mywork .hr-line { background-color: #4c6672; height: 834px; width: 1px; margin: 0 auto; }

#home article.myskills { padding: 55px 0 34px 0; line-height: 2; }
#home article.myskills h2 { color: #4c6672; margin: 0; padding: 0; }
#home article.myskills ul li { margin-bottom: 21px; }
#home article.myskills ul li p { line-height: 2; }
#home article.myskills div.skill { height: 8px; width: 210px; border: 1px solid #4c6672; }
#home article.myskills div.skill div.fill { height: 8px; background-color: #4c6672; }
#home article.myskills .hr-line { background-color: #4c6672; height: 233px; width: 1px; margin: 0 auto; }

@media (max-width: 767px) {
#home article.myself h2, article.mywork h2, article.myskills h2 { text-transform: normal ; }
#home article.myskills div.skill div.fill { float: left; }
.text-right { text-align: left; }
.pull-right { float: left; }
}

@media (min-width: 768px) {
#home h1 { font-size: 46px; }
#home article.myself h2, #home article.mywork h2, #home article.myskills h2 { text-transform: uppercase; font-size: 30px; }
#home article.myskills div.skill div.fill { float: right; }
}

/* Post */
#post .breadcumb { padding: 0 0 13px 0; }
#post { padding: 34px 0 0 0; border-top: 5px solid #4c6672; }
#post .title { margin: 34px 0 21px 0; font-weight: 500; color: #4c6672; }
#post .subtitle { margin: 0 0 55px 0; font-weight: 500; color: #a0a0a0; display: block; }

#post h2, #post h3, #post h4, #post h5, #post h6 { color: #4c6672; margin: 55px 0 0 0; }

#post p, #post ul { margin: 21px 0; line-height: 2; }
#post ul li { font-weight: 300; }

#post img { margin: 21px 0; }

#post blockquote { border-left: 2px solid #4c6672; }

#post blockquote p { margin: 0; }

#post .share { padding: 13px 0 34px 0; background-color: #f3f5f6; }
#post .share p { margin: 21px 0 0 0; line-height: 2; }

@media (max-width: 767px) {
#post .title { font-size: 28px; }
#post .subtitle { font-size: 21px; }
ul { font-size: 13px; }
}

@media (min-width: 768px) {
#post .title { font-size: 34px; }
#post .subtitle { font-size: 21px; }
#post h2 { font-size: 28px; text-transform: uppercase; text-align: center; }
#post h3, #post h4, #post h5, #post h6 { font-size: 21px; text-transform: uppercase; text-align: center; }
#post h2:before { content: "\2014 \0020"; padding-right: 13px; }
#post h2:after { content: "\2014 \0020"; padding-left: 13px; }
}


/* Footer */
footer { color: #ffffff; background-color: #4c6672; padding: 34px 0 21px 0; line-height: 2; }
footer a, footer a:visited { color: #ffffff; text-decoration: none; outline: 0; font-weight: 500; }
footer a:hover, footer a:focus { color: #ffffff; border-bottom: 1px solid #ffffff; }
footer p a, footer p a:visited { line-height: inherit; }

</style>
</head>


<div id="post" class="clearfix">

<div class="container clearfix">
<div class="row clearfix">
<div class="col-lg-offset-2 col-lg-8 col-md-offset-2 col-md-8 col-sm-12 clearfix">
<small class="breadcumb"><a href="http://www.debashisbarman.in">Home</a> &gt; Simple Kernel in C and Assembly</small>
<h1 class="title">Simple Kernel in C and Assembly</h1>
<span class="subtitle">25 Sep 2014</span>
<p>Hello, world ! Today I’m going to show you how to write a kernel in C and a little bit of assembly. This is a simple kernel written in C and Assembly which could be loaded with the GRUB bootloader on an x86 system. This kernel will
display a message on the screen and then hang. All the source code is available on my github <a href="https://github.com/debashisbarman/Simple-Kernel-in-C-and-Assembly">repository</a>.</p>

<h2 id="tools">Tools</h2>
<p>Before writing the kernel, make sure that the following tools are available on your system.</p>
<ul>
<li>An x86 computer (of course)</li>
<li>Linux</li>
<li>NASM assembler</li>
<li>gcc</li>
<li>ld (GNU Linker)</li>
<li>grub</li>
</ul>

<h2 id="lets-start-coding">Let’s start coding</h2>
<p>We like to write everything in C, but we cannot avoid a little bit of assembly. We will write a small file in x86
assembly-language that serves as the starting point for our kernel. </p>

<p>Here is our <code>kernel.asm</code> file.</p>
<pre>
;; kernel.asm
;; version 0.0.1

bits 32		;nasm directive
section .text
	;multiboot spec
	align 4
	dd 0x1BADB002			;magic
	dd 0x00				;flags
	dd - (0x1BADB002 + 0x00)	;checksum. m+f+c should be zero

global start
extern k_main	;k_main is defined in the kernel.c file

start:
	cli  ; stop interrupts

	call k_main

	hlt ; halt the CPU
</pre>

<p>In the <code>kernel.asm</code> we make a call to <code>k_main</code>. So our execution starts at <code>k_main()</code> in the main C file <code>kernel.c</code>.</p>
<pre>
/*
 *
 * kernel.c - version 0.0.1
 * 
 */


#define WHITE_TXT 0x07 /* light gray on black text */

void k_clear_screen();
unsigned int k_printf(char *message, unsigned int line);

/* simple kernel written in C */
void k_main() 
{
	k_clear_screen();
	k_printf("Hello, world! Welcome to my kernel.", 0);
};

/* k_clear_screen : to clear the entire text screen */
void k_clear_screen()
{
	char *vidmem = (char *) 0xb8000;
	unsigned int i=0;
	while(i &lt; (80*25*2))
	{
		vidmem[i]=' ';
		i++;
		vidmem[i]=WHITE_TXT;
		i++;
	};
};

/* k_printf : the message and the line # */
unsigned int k_printf(char *message, unsigned int line)
{
	char *vidmem = (char *) 0xb8000;
	unsigned int i=0;

	i=(line*80*2);

	while(*message!=0)
	{
		if(*message=='\n') // check for a new line
		{
			line++;
			i=(line*80*2);
			*message++;
		} else {
			vidmem[i]=*message;
			*message++;
			i++;
			vidmem[i]=WHITE_TXT;
			i++;
		};
	};

	return(1);
}
</pre>
<p>All our kernel will do is clear the screen and write to it the string “Hello, world! Welcome to my kernel.”</p>

<p>Now the <code>linker.ld</code> script.</p>
<pre>
/*
 * link.ld
 */

OUTPUT_FORMAT(elf32-i386)
ENTRY(start)
SECTIONS
{
	. = 0x100000;
	.text : {*(.text)}
	.data : {*(.data)}
	.bss  : {*(.bss)}
}
</pre>

<p>That’s it. All done.</p>

<h2 id="building-the-kernel">Building the kernel</h2>
<p>We will now create object files from <code>kernel.asm</code> and <code>kernel.c</code> and then link it using our linker script.</p>
<pre>
nasm -f elf32 kernel.asm -o kasm.o
</pre>
<p>Now we will run the assembler to create the object file <code>kasm.o</code> in ELF-32 bit format.</p>
<pre>
gcc -m32 -c kernel.c -o kc.o
</pre>
<p>Now the linking part,</p>
<pre>
ld -m elf_i386 -T link.ld -o kernel kasm.o kc.o
</pre>

<h2 id="configuring-the-grub">Configuring the grub</h2>
<p>GRUB requires the kernel to be of the name pattern <code>kernel-&lt;version&gt;</code> . So, I renamed my kernel executable to <code>kernel-0.0.1</code>.</p>

<p>Now place it in the <code>/boot</code> directory. You will require superuser privileges to do so.</p>

<p>In your GRUB configuration file <code>grub.cfg</code> you should add an entry, something like:</p>

<pre>
title Mini OS
  root (hd0, 0)
  kernel /boot/kernel-0.0.1 ro
</pre>

<h2 id="using-the-qemu-emulator">Using the qemu emulator</h2>
<p>The kernel will also be run using the <code>qemu</code> emulator.</p>
<pre>
qemu-system-i386 -kernel kernel
</pre>
<p>That’s it.</p>

</div>
</div>
</div>

<div class="share clearfix">
<div class="container clearfix">
<div class="row clearfix">
<div class="col-lg-offset-2 col-lg-8 col-md-offset-2 col-md-8 col-sm-12 clearfix">
<p>Did you enjoy this post? If so, <a target="_blank" href="https://twitter.com/share" data-text="Finishing" data-via="orderedlist" data-count="none">share</a> it!</p>
<p>Have comments on this post or want to discuss further? Hit me up on <a target="_blank" href="https://twitter.com/_DebashisBarman" data-show-count="false" data-show-screen-name="false">Twitter</a> and let me know your thoughts.
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>
</div>
</div>
</div>


</div>

<!-- Footer starts -->
<footer class="text-center">
<div class="container clearfix">
<div class="row clearfix">
<div class="col-lg-12 col-md-12 col-sm-12">
<p><small>&copy; 2015 <a href="">Debashis Barman</a>. Built on <a target="_blank" href="http://jekyllrb.com/">Jekyll</a> and hosted on <a target="_blank" href="http://pages.github.com/">Github Pages</a>.</small></p>
</div>
</div>
</div>
</footer>
<!-- Footer ends -->



</html>
